<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Turnity - Panel de negocio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at top left, #1d4ed8 0, transparent 55%),
        radial-gradient(circle at bottom right, #06b6d4 0, transparent 55%),
        #020617;
      color: #e5e7eb;
    }

    /* ===== TOPBAR ===== */
    .topbar {
      width: 100%;
      background: rgba(15, 23, 42, 0.96);
      border-bottom: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(16px);
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .topbar-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-mark {
      width: 30px;
      height: 30px;
      border-radius: 10px;
      border: 2px solid #38bdf8;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 30%, #38bdf8, #0f172a);
      font-weight: 700;
      color: #e0f2fe;
      font-size: 16px;
      box-shadow: 0 0 18px rgba(56, 189, 248, 0.7);
    }

    .logo span {
      font-weight: 600;
      font-size: 18px;
    }

    .topbar-center {
      display: flex;
      align-items: center;
      gap: 20px;
      flex: 1;
      justify-content: center;
    }

    .nav-links {
      display: flex;
      gap: 8px;
      padding: 4px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #1f2937;
    }

    .nav-link {
      border: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 13px;
      padding: 6px 14px;
      border-radius: 999px;
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.2s ease;
    }

    .nav-link:hover {
      opacity: 1;
      background: rgba(15, 23, 42, 0.9);
    }

    .nav-link.active {
      opacity: 1;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      box-shadow: 0 0 14px rgba(56, 189, 248, 0.7);
    }

    /* Idiomas en topbar */
    .lang-switch {
      display: flex;
      gap: 4px;
      padding: 3px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #4b5563;
    }

    .lang-btn {
      border: none;
      background: transparent;
      color: #e5e7eb;
      font-size: 11px;
      padding: 4px 6px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .lang-btn:hover {
      opacity: 1;
      background: rgba(15, 23, 42, 0.9);
    }

    .lang-btn.active {
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.7);
      opacity: 1;
    }

    .flag-icon {
      width: 16px;
      height: 11px;
      border-radius: 3px;
      object-fit: cover;
    }

    /* Lado derecho: ID y usuario */
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: #9ca3af;
    }

    .business-id-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #4b5563;
      font-size: 11px;
      white-space: nowrap;
    }

    .business-id-chip span.value {
      font-weight: 600;
      color: #e5e7eb;
    }

    .copy-btn {
      background: transparent;
      border: none;
      color: #60a5fa;
      font-size: 11px;
      cursor: pointer;
      padding: 0;
    }

    /* Chip due√±o */
    .owner-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #4b5563;
      box-shadow: 0 0 14px rgba(15, 23, 42, 0.9);
    }

    .owner-avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #38bdf8, #0f172a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
      color: #e0f2fe;
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.7);
    }

    .owner-name-main {
      font-size: 13px;
      font-weight: 600;
      color: #e5e7eb;
      max-width: 170px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .owner-role {
      font-size: 11px;
      color: #9ca3af;
    }

    .logout-btn {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }

    /* ===== LAYOUT PRINCIPAL ===== */
    .layout {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    h1 {
      font-size: 26px;
      margin-bottom: 4px;
    }

    .subtitle {
      color: #9ca3af;
      font-size: 14px;
      margin-bottom: 6px;
    }

    /* ==== l√≠nea del nombre del negocio ==== */
    .business-line {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 5px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid #4b5563;
      color: #e5e7eb;
      font-size: 12px;
      margin-bottom: 6px;
      margin-top: -2px;
      box-shadow: 0 0 14px rgba(15, 23, 42, 0.9);
    }

    .business-line-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #38bdf8, #0f172a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: #e0f2fe;
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.7);
    }

    .business-line-label {
      font-size: 11px;
      color: #9ca3af;
    }

    .business-line-name {
      font-size: 12px;
      font-weight: 600;
    }

    .grid {
      display: grid;
      grid-template-columns: 2fr 1.4fr;
      gap: 20px;
      margin-top: 16px;
    }

    .card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      padding: 18px 18px 16px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.8);
    }

    .card h2 {
      font-size: 18px;
      margin-bottom: 8px;
    }

    .card small {
      color: #9ca3af;
    }

    .mini-title {
      font-size: 13px;
      color: #9ca3af;
      margin-top: 12px;
      margin-bottom: 6px;
    }

    .service-pill {
      display: inline-block;
      padding: 5px 9px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #374151;
      font-size: 12px;
      margin-right: 4px;
      margin-bottom: 4px;
    }

    .tag {
      display: inline-block;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(34, 197, 94, 0.15);
      color: #6ee7b7;
      margin-left: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
    }

    th, td {
      padding: 8px 6px;
      text-align: left;
    }

    thead {
      background: #020617;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.8);
    }

    tbody tr:nth-child(odd) {
      background: rgba(15, 23, 42, 0.5);
    }

    th {
      color: #9ca3af;
      border-bottom: 1px solid #111827;
    }

    .status {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(56, 189, 248, 0.15);
      color: #7dd3fc;
    }

    .btn-primary {
      padding: 9px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: #fff;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(37, 99, 235, 0.8);
    }

    .btn-secondary {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
    }

    .btn-row {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* ===== SECCI√ìN MEMBRES√çAS ===== */
    .plans-section {
      margin-top: 28px;
    }

    .plans-title {
      font-size: 18px;
      margin-bottom: 10px;
    }

    .plans-subtitle {
      font-size: 13px;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    .plans-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .plan-card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 18px;
      padding: 16px 18px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.85);
    }

    .plan-name {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .plan-tagline {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 10px;
    }

    .plan-price-row {
      display: flex;
      align-items: baseline;
      gap: 4px;
      margin-bottom: 10px;
    }

    .plan-price {
      font-size: 20px;
      font-weight: 700;
    }

    .plan-currency {
      font-size: 12px;
      color: #9ca3af;
    }

    .plan-features {
      font-size: 12px;
      color: #d1d5db;
      margin-bottom: 12px;
    }

    .plan-features li {
      margin-left: 16px;
      margin-bottom: 4px;
    }

    .plan-cta {
      width: 100%;
      padding: 8px 0;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #38bdf8, #6366f1);
      color: #fff;
      font-size: 13px;
      cursor: pointer;
    }

    @media (max-width: 900px) {
      .topbar-inner {
        flex-wrap: wrap;
      }
      .topbar-center {
        order: 3;
      }
      .layout {
        padding: 16px;
      }
      .grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="logo">
        <div class="logo-mark">T</div>
        <span>Turnity</span>
      </div>

      <div class="topbar-center">
        <!-- Nav principal -->
        <div class="nav-links">
          <button class="nav-link active" data-section="panel" data-i18n="nav_panel">Panel</button>
          <button class="nav-link" data-section="agenda" data-i18n="nav_agenda">Agenda</button>
          <button class="nav-link" data-section="plans" data-i18n="nav_memberships">Membres√≠as</button>
        </div>

        <!-- Idiomas -->
        <div class="lang-switch">
          <button class="lang-btn active" data-lang="es">
            <img class="flag-icon" src="./flags/es.png" alt="ES" />
            <span>ES</span>
          </button>
          <button class="lang-btn" data-lang="en">
            <img class="flag-icon" src="./flags/us.png" alt="EN" />
            <span>EN</span>
          </button>
          <button class="lang-btn" data-lang="pt">
            <img class="flag-icon" src="./flags/br.png" alt="PT" />
            <span>PT</span>
          </button>
          <button class="lang-btn" data-lang="fr">
            <img class="flag-icon" src="./flags/fr.png" alt="FR" />
            <span>FR</span>
          </button>
          <button class="lang-btn" data-lang="de">
            <img class="flag-icon" src="./flags/de.png" alt="DE" />
            <span>DE</span>
          </button>
        </div>
      </div>

      <div class="topbar-right">
        <div class="business-id-chip">
          <span data-i18n="business_id_label">ID negocio:</span>
          <span class="value" id="businessIdValue">T-XXXXX</span>
          <button type="button" class="copy-btn" id="copyBusinessIdBtn" data-i18n="copy_btn">Copiar</button>
        </div>

        <!-- Chip due√±o -->
        <div class="owner-chip">
          <div class="owner-avatar" id="ownerAvatar">U</div>
          <div>
            <div class="owner-name-main" id="userNameTop">Nombre completo</div>
            <div class="owner-role" data-i18n="owner_role_label">Propietario</div>
          </div>
        </div>

        <button class="logout-btn" id="logoutBtn" data-i18n="btn_logout">Cerrar sesi√≥n</button>
      </div>
    </div>
  </header>

  <div class="layout">
    <h1 id="mainTitle">Panel de hoy</h1>
    <p class="subtitle" data-i18n="subtitle">
      Revisa tus turnos, ocupaci√≥n y servicios activos.
    </p>
    <p id="businessNameLine" class="business-line"></p>

    <div class="grid">
      <!-- Resumen / servicios -->
      <div class="card">
        <h2 data-i18n="summary_title">Resumen del d√≠a</h2>
        <small data-i18n="summary_hint">Vista r√°pida de c√≥mo va tu negocio hoy.</small>

        <div class="mini-title"
             style="display:flex;justify-content:space-between;align-items:center;">
          <span data-i18n="services_title">Servicios que ofreces</span>
          <button type="button" id="editBusinessBtn"
                  class="btn-secondary"
                  style="padding:6px 10px;font-size:11px;">
            <span data-i18n="btn_configure_business">Configurar negocio</span>
          </button>
        </div>

        <div id="servicesList">
          <p id="noServicesText"
             style="font-size:12px;color:#6b7280;font-style:italic;margin-top:4px;"
             data-i18n="no_services">
            A√∫n no has registrado los servicios. Haz clic en "Configurar negocio".
          </p>
        </div>
      </div>

      <!-- Turnos -->
      <div class="card" id="turnsCard">
        <h2 data-i18n="turns_title">
          Turnos de hoy <span class="tag">En vivo</span>
        </h2>
        <small data-i18n="turns_hint">Lista r√°pida de tus pr√≥ximos turnos.</small>

        <table>
          <thead>
            <tr>
              <th data-i18n="col_hour">Hora</th>
              <th data-i18n="col_client">Cliente</th>
              <th data-i18n="col_service">Servicio</th>
              <th data-i18n="col_status">Estado</th>
              <th data-i18n="col_actions">Acciones</th>
            </tr>
          </thead>
          <tbody id="turnsBody">
            <tr>
              <td colspan="5" style="font-size:12px;color:#9ca3af;padding:12px 6px;"
                  data-i18n="no_turns">
                A√∫n no hay turnos cargados. Aqu√≠ ver√°s los turnos cuando los vayas agregando.
              </td>
            </tr>
          </tbody>
        </table>

        <div class="btn-row">
          <button class="btn-primary" data-i18n="btn_add_turn">Agregar turno</button>
          <button class="btn-secondary" data-i18n="btn_full_agenda">Ver agenda completa</button>
        </div>
      </div>
    </div>

    <!-- MEMBRES√çAS -->
    <section class="plans-section" id="plansSection">
      <h2 class="plans-title" data-i18n="plans_title">Membres√≠as</h2>
      <p class="plans-subtitle" data-i18n="plans_subtitle">
        Los precios se muestran en tu moneda local seg√∫n el pa√≠s que elegiste al registrarte.
      </p>

      <div class="plans-grid">
        <!-- Plan Gratis -->
        <article class="plan-card">
          <div class="plan-name" data-i18n="plan_free_name">Gratis</div>
          <div class="plan-tagline" data-i18n="plan_free_tagline">
            Ideal para probar Turnity y manejar pocos turnos.
          </div>
          <div class="plan-price-row">
            <div class="plan-price" id="priceFree">$0</div>
            <div class="plan-currency" data-i18n="per_month_label">/ mes</div>
          </div>
          <ul class="plan-features">
            <li data-i18n="plan_free_f1">Hasta 50 reservas al mes.</li>
            <li data-i18n="plan_free_f2">Recordatorios b√°sicos por correo.</li>
            <li data-i18n="plan_free_f3">Un solo negocio.</li>
          </ul>
          <button class="plan-cta" data-i18n="plan_select_btn">Elegir este plan</button>
        </article>

        <!-- Plan Pro -->
        <article class="plan-card">
          <div class="plan-name" data-i18n="plan_pro_name">Pro</div>
          <div class="plan-tagline" data-i18n="plan_pro_tagline">
            Para negocios en crecimiento que necesitan automatizar m√°s.
          </div>
          <div class="plan-price-row">
            <div class="plan-price" id="pricePro">$19</div>
            <div class="plan-currency" data-i18n="per_month_label">/ mes</div>
          </div>
          <ul class="plan-features">
            <li data-i18n="plan_pro_f1">Reservas ilimitadas.</li>
            <li data-i18n="plan_pro_f2">Recordatorios por correo y notificaci√≥n.</li>
            <li data-i18n="plan_pro_f3">M√∫ltiples trabajadores por negocio.</li>
          </ul>
          <button class="plan-cta" data-i18n="plan_select_btn">Elegir este plan</button>
        </article>

        <!-- Plan Premium -->
        <article class="plan-card">
          <div class="plan-name" data-i18n="plan_premium_name">Premium</div>
          <div class="plan-tagline" data-i18n="plan_premium_tagline">
            Para cadenas y negocios que necesitan reportes y soporte prioritario.
          </div>
          <div class="plan-price-row">
            <div class="plan-price" id="pricePremium">$39</div>
            <div class="plan-currency" data-i18n="per_month_label">/ mes</div>
          </div>
          <ul class="plan-features">
            <li data-i18n="plan_premium_f1">Todo lo del plan Pro.</li>
            <li data-i18n="plan_premium_f2">Reportes avanzados y exportaciones.</li>
            <li data-i18n="plan_premium_f3">Soporte prioritario.</li>
          </ul>
          <button class="plan-cta" data-i18n="plan_select_btn">Elegir este plan</button>
        </article>
      </div>
    </section>
  </div>

  <!-- MODAL CONFIGURAR NEGOCIO -->
  <div id="businessModal"
       style="display:none;position:fixed;inset:0;z-index:50;
              background:rgba(15,23,42,0.8);backdrop-filter:blur(4px);
              align-items:center;justify-content:center;">
    <div style="background:#020617;border-radius:18px;border:1px solid #4b5563;
                padding:18px 20px;width:100%;max-width:420px;
                box-shadow:0 18px 40px rgba(15,23,42,0.9);">
      <h3 style="margin-bottom:10px;font-size:18px;" data-i18n="modal_title">
        Configurar negocio
      </h3>

      <label style="font-size:13px;display:block;margin-bottom:4px;" data-i18n="modal_name_label">
        Nombre del negocio
      </label>
      <input id="businessNameInput" type="text"
             style="width:100%;padding:8px 10px;
                    border-radius:999px;border:1px solid #374151;
                    background:#020617;color:#e5e7eb;font-size:13px;" />
      <p style="font-size:11px;color:#6b7280;margin:4px 0 10px;"
         data-i18n="modal_name_hint">
        Este nombre aparecer√° en tu panel y en las reservas que vean tus clientes.
      </p>

      <label style="font-size:13px;display:block;margin-bottom:4px;" data-i18n="modal_desc_label">
        Descripci√≥n
      </label>
      <textarea id="businessDescInput" rows="3"
                style="width:100%;margin-bottom:10px;padding:8px 10px;
                       border-radius:12px;border:1px solid #374151;
                       background:#020617;color:#e5e7eb;font-size:13px;
                       resize:vertical;"></textarea>

      <label style="font-size:13px;display:block;margin-bottom:4px;" data-i18n="modal_services_label">
        Servicios (separados por coma)
      </label>
      <input id="businessServicesInput" type="text"
             placeholder="Cortes, Barba, Cejas"
             style="width:100%;margin-bottom:14px;padding:8px 10px;
                    border-radius:999px;border:1px solid #374151;
                    background:#020617;color:#e5e7eb;font-size:13px;" />

      <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button type="button" id="cancelBusinessBtn"
                class="btn-secondary" style="font-size:12px;"
                data-i18n="btn_cancel">
          Cancelar
        </button>
        <button type="button" id="saveBusinessBtn"
                class="btn-primary" style="font-size:12px;"
                data-i18n="btn_save">
          Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL AGREGAR TURNO -->
  <div id="turnModal"
       style="display:none;position:fixed;inset:0;z-index:50;
              background:rgba(15,23,42,0.8);backdrop-filter:blur(4px);
              align-items:center;justify-content:center;">
    <div style="background:#020617;border-radius:18px;border:1px solid #4b5563;
                padding:18px 20px;width:100%;max-width:420px;
                box-shadow:0 18px 40px rgba(15,23,42,0.9);">
      <h3 style="margin-bottom:10px;font-size:18px;" data-i18n="turn_modal_title">
        Agregar turno
      </h3>

      <label style="font-size:13px;display:block;margin-bottom:4px;" data-i18n="turn_modal_time_label">
        Hora
      </label>
      <input id="turnTimeInput" type="time"
             style="width:100%;padding:8px 10px;
                    border-radius:999px;border:1px solid #374151;
                    background:#020617;color:#e5e7eb;font-size:13px;margin-bottom:10px;" />

      <label style="font-size:13px;display:block;margin-bottom:4px;" data-i18n="turn_modal_client_label">
        Cliente
      </label>
      <input id="turnClientInput" type="text"
             placeholder="Nombre del cliente"
             style="width:100%;padding:8px 10px;
                    border-radius:999px;border:1px solid #374151;
                    background:#020617;color:#e5e7eb;font-size:13px;margin-bottom:10px;" />

      <label style="font-size:13px;display:block;margin-bottom:4px;" data-i18n="turn_modal_service_label">
        Servicio
      </label>
      <select id="turnServiceSelect"
              style="width:100%;padding:8px 10px;
                     border-radius:999px;border:1px solid #374151;
                     background:#020617;color:#e5e7eb;font-size:13px;margin-bottom:10px;">
        <option value="" disabled selected>Selecciona un servicio</option>
      </select>

      <label style="font-size:13px;display:block;margin-bottom:4px;" data-i18n="turn_modal_status_label">
        Estado
      </label>
      <select id="turnStatusSelect"
              style="width:100%;padding:8px 10px;
                     border-radius:999px;border:1px solid #374151;
                     background:#020617;color:#e5e7eb;font-size:13px;margin-bottom:14px;">
        <option value="Confirmado">Confirmado</option>
        <option value="Pendiente">Pendiente</option>
        <option value="Recordatorio">Recordatorio</option>
      </select>

      <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button type="button" id="cancelTurnBtn"
                class="btn-secondary" style="font-size:12px;"
                data-i18n="btn_cancel">
          Cancelar
        </button>
        <button type="button" id="saveTurnBtn"
                class="btn-primary" style="font-size:12px;"
                data-i18n="turn_modal_save_btn">
          Guardar turno
        </button>
      </div>
    </div>
  </div>

  <script>
    // ====== FUNCIONES PARA USUARIO ACTUAL (usa turnityUser) ======
    function getCurrentUser() {
      const raw = localStorage.getItem("turnityUser");
      if (raw) {
        try {
          return JSON.parse(raw);
        } catch (e) {
          console.error("Error parseando turnityUser:", e);
        }
      }

      // Fallback: formato viejo
      const name = localStorage.getItem("turnity_user_name");
      const role = localStorage.getItem("turnity_user_role");
      const email = localStorage.getItem("turnity_user_email");
      if (name || role || email) {
        return {
          id: null,
          name: name || "Usuario",
          role: role || "negocio",
          email: email || null,
        };
      }

      return null;
    }

    const currentUser = getCurrentUser();
    const token = localStorage.getItem("turnity_token");

    // Redirecciones seg√∫n sesi√≥n y rol
    if (!token || !currentUser || !currentUser.role) {
      window.location.href = "login.html";
    } else if (currentUser.role === "usuario") {
      window.location.href = "usuario-dashboard.html";
    }

    // Clave √∫nica por usuario para guardar negocio/servicios
    const userKey = currentUser && (currentUser.id || currentUser._id || currentUser.email)
      ? (currentUser.id || currentUser._id || currentUser.email)
      : (currentUser && currentUser.name ? currentUser.name : "guest");

    // ==== PINTAR DATOS DEL DUE√ëO ====
    const ownerAvatar = document.getElementById("ownerAvatar");
    const ownerNameTop = document.getElementById("userNameTop");
    const mainTitleEl = document.getElementById("mainTitle");

    const displayName = currentUser && currentUser.name ? currentUser.name : "Usuario";

    ownerNameTop.textContent = displayName;
    mainTitleEl.textContent = `Panel de ${displayName}`;
    const initial = displayName.trim().charAt(0).toUpperCase() || "U";
    ownerAvatar.textContent = initial;

    // ==== ID de negocio persistente POR USUARIO ====
    function getOrCreateBusinessId() {
      const key = `turnity_business_id_${userKey}`;
      let id = localStorage.getItem(key);
      if (!id) {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let code = "T-";
        for (let i = 0; i < 5; i++) {
          code += chars[Math.floor(Math.random() * chars.length)];
        }
        id = code;
        localStorage.setItem(key, id);
      }
      return id;
    }

    const businessIdSpan = document.getElementById("businessIdValue");
    const businessId = getOrCreateBusinessId();
    if (businessIdSpan) {
      businessIdSpan.textContent = businessId;
    }

    const copyBusinessIdBtn = document.getElementById("copyBusinessIdBtn");
    if (copyBusinessIdBtn) {
      copyBusinessIdBtn.addEventListener("click", () => {
        const text = businessIdSpan.textContent;
        if (navigator.clipboard && text) {
          navigator.clipboard.writeText(text).then(
            () => alert("ID de negocio copiado: " + text),
            () => alert("No se pudo copiar el ID, c√≥pialo manualmente.")
          );
        } else {
          alert("ID de negocio: " + text);
        }
      });
    }

    const businessNameLine = document.getElementById("businessNameLine");
    let currentBusinessName =
      localStorage.getItem(`turnity_business_name_${userKey}`) || "";

    // ==== Cerrar sesi√≥n ====
    document.getElementById("logoutBtn").addEventListener("click", () => {
      localStorage.removeItem("turnity_token");
      localStorage.removeItem("turnity_user_role");
      localStorage.removeItem("turnity_user_name");
      localStorage.removeItem("turnityUser");
      window.location.href = "login.html";
    });

    // ===== CONFIGURACI√ìN MONEDA POR PA√çS =====
    const BASE_PRICES_USD = {
      free: 0,
      pro: 19,
      premium: 39,
    };

    // Tasas de conversi√≥n aproximadas (puedes ajustarlas cuando quieras)
    const currencyConfigByCountry = {
      US: { currency: "USD", locale: "en-US", rate: 1 },
      CO: { currency: "COP", locale: "es-CO", rate: 4000 },   // 1 USD ‚âà 4000 COP
      MX: { currency: "MXN", locale: "es-MX", rate: 18 },     // 1 USD ‚âà 18 MXN
      CL: { currency: "CLP", locale: "es-CL", rate: 900 },    // 1 USD ‚âà 900 CLP
      ES: { currency: "EUR", locale: "es-ES", rate: 0.92 },   // 1 USD ‚âà 0.92 EUR
    };

    function getUserCountry() {
      let c = localStorage.getItem("turnity_country");
      if (!c && currentUser && currentUser.country) {
        c = currentUser.country;
      }
      // fallback
      return c || "US";
    }

    function formatPriceForUser(usdAmount) {
      const country = getUserCountry();
      const cfg = currencyConfigByCountry[country] || currencyConfigByCountry.US;
      const amount = usdAmount * cfg.rate;

      const formatter = new Intl.NumberFormat(cfg.locale, {
        style: "currency",
        currency: cfg.currency,
        maximumFractionDigits:
          cfg.currency === "COP" || cfg.currency === "CLP" ? 0 : 2,
      });

      return formatter.format(amount);
    }

    function updatePlanPrices() {
      const freeEl = document.getElementById("priceFree");
      const proEl = document.getElementById("pricePro");
      const premiumEl = document.getElementById("pricePremium");

      if (freeEl) freeEl.textContent = formatPriceForUser(BASE_PRICES_USD.free);
      if (proEl) proEl.textContent = formatPriceForUser(BASE_PRICES_USD.pro);
      if (premiumEl) premiumEl.textContent = formatPriceForUser(BASE_PRICES_USD.premium);
    }

    // ==== IDIOMAS ====
    const translations = {
      es: {
        nav_panel: "Panel",
        nav_agenda: "Agenda",
        nav_memberships: "Membres√≠as",
        business_id_label: "ID negocio:",
        copy_btn: "Copiar",
        btn_logout: "Cerrar sesi√≥n",
        subtitle: "Revisa tus turnos, ocupaci√≥n y servicios activos.",
        summary_title: "Resumen del d√≠a",
        summary_hint: "Vista r√°pida de c√≥mo va tu negocio hoy.",
        services_title: "Servicios que ofreces",
        btn_configure_business: "Configurar negocio",
        no_services: 'A√∫n no has registrado los servicios. Haz clic en "Configurar negocio".',
        turns_title: "Turnos de hoy",
        turns_hint: "Lista r√°pida de tus pr√≥ximos turnos.",
        col_hour: "Hora",
        col_client: "Cliente",
        col_service: "Servicio",
        col_status: "Estado",
        col_actions: "Acciones",
        no_turns:
          "A√∫n no hay turnos cargados. Aqu√≠ ver√°s los turnos cuando los vayas agregando.",
        btn_add_turn: "Agregar turno",
        btn_full_agenda: "Ver agenda completa",
        plans_title: "Membres√≠as",
        plans_subtitle:
          "Los precios se muestran en tu moneda local seg√∫n el pa√≠s que elegiste al registrarte.",
        plan_free_name: "Gratis",
        plan_free_tagline: "Ideal para probar Turnity y manejar pocos turnos.",
        plan_free_f1: "Hasta 50 reservas al mes.",
        plan_free_f2: "Recordatorios b√°sicos por correo.",
        plan_free_f3: "Un solo negocio.",
        plan_pro_name: "Pro",
        plan_pro_tagline: "Para negocios en crecimiento que necesitan automatizar m√°s.",
        plan_pro_f1: "Reservas ilimitadas.",
        plan_pro_f2: "Recordatorios por correo y notificaci√≥n.",
        plan_pro_f3: "M√∫ltiples trabajadores por negocio.",
        plan_premium_name: "Premium",
        plan_premium_tagline:
          "Para cadenas y negocios que necesitan reportes y soporte prioritario.",
        plan_premium_f1: "Todo lo del plan Pro.",
        plan_premium_f2: "Reportes avanzados y exportaciones.",
        plan_premium_f3: "Soporte prioritario.",
        plan_select_btn: "Elegir este plan",
        per_month_label: "/ mes",
        modal_title: "Configurar negocio",
        modal_name_label: "Nombre del negocio",
        modal_name_hint:
          "Este nombre aparecer√° en tu panel y en las reservas que vean tus clientes.",
        modal_desc_label: "Descripci√≥n",
        modal_services_label: "Servicios (separados por coma)",
        btn_cancel: "Cancelar",
        btn_save: "Guardar",
        business_label_prefix: "Negocio: ",
        owner_role_label: "Propietario",
        // Modal turnos
        turn_modal_title: "Agregar turno",
        turn_modal_time_label: "Hora",
        turn_modal_client_label: "Cliente",
        turn_modal_service_label: "Servicio",
        turn_modal_status_label: "Estado",
        turn_modal_save_btn: "Guardar turno",
      },
      en: {
        nav_panel: "Dashboard",
        nav_agenda: "Schedule",
        nav_memberships: "Plans",
        business_id_label: "Business ID:",
        copy_btn: "Copy",
        btn_logout: "Log out",
        subtitle: "Check your appointments, occupancy and active services.",
        summary_title: "Day overview",
        summary_hint: "Quick view of how your business is doing today.",
        services_title: "Services you offer",
        btn_configure_business: "Configure business",
        no_services: 'You haven‚Äôt added services yet. Click "Configure business".',
        turns_title: "Today‚Äôs appointments",
        turns_hint: "Quick list of your next appointments.",
        col_hour: "Time",
        col_client: "Client",
        col_service: "Service",
        col_status: "Status",
        col_actions: "Actions",
        no_turns:
          "No appointments yet. You will see them here as you add new ones.",
        btn_add_turn: "Add appointment",
        btn_full_agenda: "View full schedule",
        plans_title: "Memberships",
        plans_subtitle:
          "Prices are shown in your local currency according to the country you selected.",
        plan_free_name: "Free",
        plan_free_tagline: "Perfect to try Turnity and handle a few bookings.",
        plan_free_f1: "Up to 50 bookings per month.",
        plan_free_f2: "Basic email reminders.",
        plan_free_f3: "Single business.",
        plan_pro_name: "Pro",
        plan_pro_tagline: "For growing businesses that need more automation.",
        plan_pro_f1: "Unlimited bookings.",
        plan_pro_f2: "Email and notification reminders.",
        plan_pro_f3: "Multiple workers per business.",
        plan_premium_name: "Premium",
        plan_premium_tagline: "For chains needing reports and priority support.",
        plan_premium_f1: "Everything in Pro.",
        plan_premium_f2: "Advanced reports and exports.",
        plan_premium_f3: "Priority support.",
        plan_select_btn: "Select this plan",
        per_month_label: "per month",
        modal_title: "Configure business",
        modal_name_label: "Business name",
        modal_name_hint:
          "This name will appear on your dashboard and on the bookings your clients see.",
        modal_desc_label: "Description",
        modal_services_label: "Services (comma separated)",
        btn_cancel: "Cancel",
        btn_save: "Save",
        business_label_prefix: "Business: ",
        owner_role_label: "Owner",
        turn_modal_title: "Add appointment",
        turn_modal_time_label: "Time",
        turn_modal_client_label: "Client",
        turn_modal_service_label: "Service",
        turn_modal_status_label: "Status",
        turn_modal_save_btn: "Save appointment",
      },
      // los otros idiomas (pt, fr, de) los dejamos igual que antes sin textos nuevos
      // para no alargar demasiado; seguir√°n mostrando los labels en espa√±ol para el modal de turnos.
      pt: {
        nav_panel: "Painel",
        nav_agenda: "Agenda",
        nav_memberships: "Planos",
        business_id_label: "ID do neg√≥cio:",
        copy_btn: "Copiar",
        btn_logout: "Sair",
        subtitle: "Veja seus hor√°rios, ocupa√ß√£o e servi√ßos ativos.",
        summary_title: "Resumo do dia",
        summary_hint: "Vis√£o r√°pida de como est√° o seu neg√≥cio hoje.",
        services_title: "Servi√ßos que voc√™ oferece",
        btn_configure_business: "Configurar neg√≥cio",
        no_services: 'Voc√™ ainda n√£o cadastrou servi√ßos. Clique em "Configurar neg√≥cio".',
        turns_title: "Hor√°rios de hoje",
        turns_hint: "Lista r√°pida dos pr√≥ximos hor√°rios.",
        col_hour: "Hora",
        col_client: "Cliente",
        col_service: "Servi√ßo",
        col_status: "Status",
        col_actions: "A√ß√µes",
        no_turns:
          "Ainda n√£o h√° hor√°rios. Eles aparecer√£o aqui conforme voc√™ for adicionando.",
        btn_add_turn: "Adicionar hor√°rio",
        btn_full_agenda: "Ver agenda completa",
        plans_title: "Planos",
        plans_subtitle:
          "Os pre√ßos s√£o exibidos na sua moeda local, conforme o pa√≠s escolhido no cadastro.",
        plan_free_name: "Gr√°tis",
        plan_free_tagline: "Ideal para testar o Turnity com poucos hor√°rios.",
        plan_free_f1: "At√© 50 reservas por m√™s.",
        plan_free_f2: "Lembretes b√°sicos por e-mail.",
        plan_free_f3: "Apenas um neg√≥cio.",
        plan_pro_name: "Pro",
        plan_pro_tagline: "Para neg√≥cios em crescimento que precisam automatizar mais.",
        plan_pro_f1: "Reservas ilimitadas.",
        plan_pro_f2: "Lembretes por e-mail e notifica√ß√£o.",
        plan_pro_f3: "V√°rios funcion√°rios por neg√≥cio.",
        plan_premium_name: "Premium",
        plan_premium_tagline: "Para redes que precisam de relat√≥rios e suporte priorit√°rio.",
        plan_premium_f1: "Tudo do plano Pro.",
        plan_premium_f2: "Relat√≥rios avan√ßados e exporta√ß√µes.",
        plan_premium_f3: "Suporte priorit√°rio.",
        plan_select_btn: "Escolher este plano",
        per_month_label: "por m√™s",
        modal_title: "Configurar neg√≥cio",
        modal_name_label: "Nome do neg√≥cio",
        modal_name_hint:
          "Este nome aparecer√° no seu painel e nas reservas que os clientes veem.",
        modal_desc_label: "Descri√ß√£o",
        modal_services_label: "Servi√ßos (separados por v√≠rgula)",
        btn_cancel: "Cancelar",
        btn_save: "Salvar",
        business_label_prefix: "Neg√≥cio: ",
        owner_role_label: "Propriet√°rio",
      },
      fr: {
        nav_panel: "Tableau",
        nav_agenda: "Agenda",
        nav_memberships: "Abonnements",
        business_id_label: "ID du commerce :",
        copy_btn: "Copier",
        btn_logout: "Se d√©connecter",
        subtitle: "Consulte vos rendez-vous, votre occupation et vos services actifs.",
        summary_title: "R√©sum√© du jour",
        summary_hint: "Vue rapide de l‚Äôactivit√© de votre commerce aujourd‚Äôhui.",
        services_title: "Services propos√©s",
        btn_configure_business: "Configurer le commerce",
        no_services:
          'Vous n‚Äôavez pas encore ajout√© de services. Cliquez sur ¬´ Configurer le commerce ¬ª.',

        turns_title: "Rendez-vous du jour",
        turns_hint: "Liste rapide de vos prochains rendez-vous.",
        col_hour: "Heure",
        col_client: "Client",
        col_service: "Service",
        col_status: "Statut",
        col_actions: "Actions",
        no_turns:
          "Encore aucun rendez-vous. Ils s‚Äôafficheront ici au fur et √† mesure.",
        btn_add_turn: "Ajouter un rendez-vous",
        btn_full_agenda: "Voir l‚Äôagenda complet",
        plans_title: "Abonnements",
        plans_subtitle:
          "Les prix sont affich√©s dans votre monnaie locale, selon le pays choisi √† l‚Äôinscription.",
        plan_free_name: "Gratuit",
        plan_free_tagline: "Id√©al pour tester Turnity avec peu de rendez-vous.",
        plan_free_f1: "Jusqu‚Äô√† 50 r√©servations par mois.",
        plan_free_f2: "Rappels e-mail basiques.",
        plan_free_f3: "Un seul commerce.",
        plan_pro_name: "Pro",
        plan_pro_tagline: "Pour les commerces en croissance qui veulent plus d‚Äôautomatisation.",
        plan_pro_f1: "R√©servations illimit√©es.",
        plan_pro_f2: "Rappels par e-mail et notification.",
        plan_pro_f3: "Plusieurs employ√©s par commerce.",
        plan_premium_name: "Premium",
        plan_premium_tagline:
          "Pour les cha√Ænes qui ont besoin de rapports d√©taill√©s et de support prioritaire.",
        plan_premium_f1: "Tout ce du plan Pro.",
        plan_premium_f2: "Rapports avanc√©s et exports.",
        plan_premium_f3: "Support prioritaire.",
        plan_select_btn: "Choisir cet abonnement",
        per_month_label: "par mois",
        modal_title: "Configurer le commerce",
        modal_name_label: "Nom du commerce",
        modal_name_hint:
          "Ce nom appara√Ætra dans votre tableau de bord et sur les r√©servations vues par vos clients.",
        modal_desc_label: "Description",
        modal_services_label: "Services (s√©par√©s par des virgules)",
        btn_cancel: "Annuler",
        btn_save: "Enregistrer",
        business_label_prefix: "Commerce : ",
        owner_role_label: "Propri√©taire",
      },
      de: {
        nav_panel: "Dashboard",
        nav_agenda: "Kalender",
        nav_memberships: "Tarife",
        business_id_label: "Gesch√§fts-ID:",
        copy_btn: "Kopieren",
        btn_logout: "Abmelden",
        subtitle: "Pr√ºfe deine Termine, Auslastung und aktiven Services.",
        summary_title: "Tages√ºbersicht",
        summary_hint: "Schneller Blick darauf, wie dein Gesch√§ft heute l√§uft.",
        services_title: "Angebotene Services",
        btn_configure_business: "Gesch√§ft konfigurieren",
        no_services:
          'Du hast noch keine Services eingetragen. Klicke auf ‚ÄûGesch√§ft konfigurieren‚Äú.',
        turns_title: "Heutige Termine",
        turns_hint: "Schnelle Liste deiner n√§chsten Termine.",
        col_hour: "Uhrzeit",
        col_client: "Kunde",
        col_service: "Service",
        col_status: "Status",
        col_actions: "Aktionen",
        no_turns:
          "Noch keine Termine. Sie werden hier angezeigt, sobald du sie hinzuf√ºgst.",
        btn_add_turn: "Termin hinzuf√ºgen",
        btn_full_agenda: "Kompletten Kalender ansehen",
        plans_title: "Tarife",
        plans_subtitle:
          "Preise werden in deiner lokalen W√§hrung angezeigt, basierend auf dem gew√§hlten Land.",
        plan_free_name: "Gratis",
        plan_free_tagline: "Ideal, um Turnity mit wenigen Terminen zu testen.",
        plan_free_f1: "Bis zu 50 Buchungen pro Monat.",
        plan_free_f2: "Einfache E-Mail-Erinnerungen.",
        plan_free_f3: "Ein Gesch√§ft.",
        plan_pro_name: "Pro",
        plan_pro_tagline: "F√ºr wachsende Unternehmen mit mehr Automatisierung.",
        plan_pro_f1: "Unbegrenzte Buchungen.",
        plan_pro_f2: "Erinnerungen per E-Mail und Benachrichtigung.",
        plan_pro_f3: "Mehrere Mitarbeitende pro Gesch√§ft.",
        plan_premium_name: "Premium",
        plan_premium_tagline:
          "F√ºr Ketten mit Bedarf an Berichten und priorisiertem Support.",
        plan_premium_f1: "Alles aus dem Pro-Tarif.",
        plan_premium_f2: "Erweiterte Berichte und Exporte.",
        plan_premium_f3: "Priorisierter Support.",
        plan_select_btn: "Diesen Tarif w√§hlen",
        per_month_label: "pro Monat",
        modal_title: "Gesch√§ft konfigurieren",
        modal_name_label: "Name des Gesch√§fts",
        modal_name_hint:
          "Dieser Name erscheint im Dashboard und auf den Buchungen deiner Kund:innen.",
        modal_desc_label: "Beschreibung",
        modal_services_label: "Services (durch Komma getrennt)",
        btn_cancel: "Abbrechen",
        btn_save: "Speichern",
        business_label_prefix: "Gesch√§ft: ",
        owner_role_label: "Inhaber",
      },
    };

    let currentLang = "es";

    function updateBusinessNameLineForLang(lang) {
      const t = translations[lang] || translations.es;
      if (!businessNameLine) return;

      if (currentBusinessName) {
        const label = t.business_label_prefix || "Negocio: ";
        businessNameLine.innerHTML = `
          <span class="business-line-icon">üè™</span>
          <span class="business-line-label">${label}</span>
          <span class="business-line-name">${currentBusinessName}</span>
        `;
      } else {
        businessNameLine.innerHTML = "";
      }
    }

    function applyLanguage(lang) {
      currentLang = lang;
      const t = translations[lang] || translations.es;

      document.querySelectorAll("[data-i18n]").forEach((el) => {
        const key = el.dataset.i18n;
        if (t[key]) el.textContent = t[key];
      });

      updateBusinessNameLineForLang(lang);
    }

    const langButtons = document.querySelectorAll(".lang-btn");
    langButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        langButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        applyLanguage(btn.dataset.lang);
      });
    });

    applyLanguage("es");

    // ==== NAV VISUAL ====
    const navLinks = document.querySelectorAll(".nav-link");
    const plansSection = document.getElementById("plansSection");
    const turnsCard = document.getElementById("turnsCard");

    navLinks.forEach((link) => {
      link.addEventListener("click", () => {
        navLinks.forEach((l) => l.classList.remove("active"));
        link.classList.add("active");

        const section = link.dataset.section;
        if (section === "panel") {
          window.scrollTo({ top: 0, behavior: "smooth" });
        } else if (section === "agenda") {
          if (turnsCard) {
            const rect = turnsCard.getBoundingClientRect();
            const offsetTop = window.scrollY + rect.top - 80;
            window.scrollTo({ top: offsetTop, behavior: "smooth" });
          }
        } else if (section === "plans") {
          if (plansSection) {
            const rect = plansSection.getBoundingClientRect();
            const offsetTop = window.scrollY + rect.top - 80;
            window.scrollTo({ top: offsetTop, behavior: "smooth" });
          }
        }
      });
    });

    // ==== CONFIGURAR NEGOCIO Y SERVICIOS POR USUARIO ====
    const editBusinessBtn = document.getElementById("editBusinessBtn");
    const businessModal = document.getElementById("businessModal");
    const cancelBusinessBtn = document.getElementById("cancelBusinessBtn");
    const saveBusinessBtn = document.getElementById("saveBusinessBtn");
    const businessNameInput = document.getElementById("businessNameInput");
    const businessDescInput = document.getElementById("businessDescInput");
    const businessServicesInput = document.getElementById("businessServicesInput");
    const servicesList = document.getElementById("servicesList");
    const noServicesText = document.getElementById("noServicesText");

    function getBusinessServicesArray() {
      const key = `turnity_business_services_${userKey}`;
      const servicesRaw = localStorage.getItem(key) || "";
      return servicesRaw
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean);
    }

    function renderServices() {
      const services = getBusinessServicesArray();

      // borrar pills anteriores
      servicesList.querySelectorAll(".service-pill").forEach((el) => el.remove());

      if (services.length === 0) {
        if (noServicesText) noServicesText.style.display = "block";
        return;
      }
      if (noServicesText) noServicesText.style.display = "none";

      services.forEach((s) => {
        const pill = document.createElement("span");
        pill.className = "service-pill";
        pill.textContent = s;
        servicesList.appendChild(pill);
      });
    }

    if (editBusinessBtn && businessModal) {
      editBusinessBtn.addEventListener("click", () => {
        const nameKey = `turnity_business_name_${userKey}`;
        const descKey = `turnity_business_description_${userKey}`;
        const servicesKey = `turnity_business_services_${userKey}`;

        const storedName = localStorage.getItem(nameKey) || "";
        const storedDesc = localStorage.getItem(descKey) || "";
        const storedServices = localStorage.getItem(servicesKey) || "";

        businessNameInput.value = storedName;
        businessDescInput.value = storedDesc;
        businessServicesInput.value = storedServices;
        businessModal.style.display = "flex";
      });

      cancelBusinessBtn.addEventListener("click", () => {
        businessModal.style.display = "none";
      });

      saveBusinessBtn.addEventListener("click", () => {
        const nameVal = businessNameInput.value.trim();
        const descVal = businessDescInput.value.trim();
        const servicesVal = businessServicesInput.value.trim();

        const nameKey = `turnity_business_name_${userKey}`;
        const descKey = `turnity_business_description_${userKey}`;
        const servicesKey = `turnity_business_services_${userKey}`;

        if (nameVal) {
          currentBusinessName = nameVal;
          localStorage.setItem(nameKey, nameVal);
        } else {
          currentBusinessName = "";
          localStorage.removeItem(nameKey);
        }

        localStorage.setItem(descKey, descVal);
        localStorage.setItem(servicesKey, servicesVal);

        renderServices();
        updateBusinessNameLineForLang(currentLang);
        businessModal.style.display = "none";
      });

      // cerrar si se hace click fuera del cuadro
      businessModal.addEventListener("click", (e) => {
        if (e.target === businessModal) {
          businessModal.style.display = "none";
        }
      });
    }

    // ====== TURNOS (LOCALSTORAGE POR BUSINESS ID) ======
    const turnsBody = document.getElementById("turnsBody");
    const addTurnBtn = document.querySelector('[data-i18n="btn_add_turn"]');

    const turnModal = document.getElementById("turnModal");
    const cancelTurnBtn = document.getElementById("cancelTurnBtn");
    const saveTurnBtn = document.getElementById("saveTurnBtn");
    const turnTimeInput = document.getElementById("turnTimeInput");
    const turnClientInput = document.getElementById("turnClientInput");
    const turnServiceSelect = document.getElementById("turnServiceSelect");
    const turnStatusSelect = document.getElementById("turnStatusSelect");

    function loadTurns() {
      const key = `turnity_turns_${businessId}`;
      const raw = localStorage.getItem(key);
      if (!raw) return [];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (e) {
        console.error("Error parseando turnos:", e);
        return [];
      }
    }

    function saveTurns(turns) {
      const key = `turnity_turns_${businessId}`;
      localStorage.setItem(key, JSON.stringify(turns));
    }

    // üî¥ NUEVA FUNCI√ìN: eliminar turno por ID
    function deleteTurn(id) {
      const turns = loadTurns();
      const updated = turns.filter((t) => t.id !== id);
      saveTurns(updated);
      renderTurns();
    }

    // üîÅ Renderizar turnos en tabla (con bot√≥n de eliminar)
    function renderTurns() {
      const turns = loadTurns();
      turnsBody.innerHTML = "";

      if (turns.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.style.fontSize = "12px";
        td.style.color = "#9ca3af";
        td.style.padding = "12px 6px";
        td.textContent =
          translations[currentLang]?.no_turns || translations.es.no_turns;
        tr.appendChild(td);
        turnsBody.appendChild(tr);
        return;
      }

      // Ordenar por hora ascendente
      turns.sort((a, b) => (a.time || "").localeCompare(b.time || ""));

      turns.forEach((t) => {
        const tr = document.createElement("tr");

        const tdTime = document.createElement("td");
        tdTime.textContent = t.time || "-";

        const tdClient = document.createElement("td");
        tdClient.textContent = t.client || "-";

        const tdService = document.createElement("td");
        tdService.textContent = t.service || "-";

        const tdStatus = document.createElement("td");
        const span = document.createElement("span");
        span.className = "status";
        span.textContent = t.status || "Pendiente";
        tdStatus.appendChild(span);

        // Columna de acciones (bot√≥n eliminar)
        const tdActions = document.createElement("td");
        const btnDel = document.createElement("button");
        btnDel.textContent = "‚úï";
        btnDel.title = "Eliminar turno";
        btnDel.style.cssText =
          "font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #4b5563;background:#020617;color:#fca5a5;cursor:pointer;";
        btnDel.addEventListener("click", () => {
          const msg =
            currentLang === "en"
              ? "Are you sure you want to delete this appointment?"
              : "¬øSeguro que quieres eliminar este turno?";
          if (confirm(msg)) {
            deleteTurn(t.id);
          }
        });
        tdActions.appendChild(btnDel);

        tr.appendChild(tdTime);
        tr.appendChild(tdClient);
        tr.appendChild(tdService);
        tr.appendChild(tdStatus);
        tr.appendChild(tdActions);

        turnsBody.appendChild(tr);
      });
    }

    function fillServicesInTurnSelect() {
      const services = getBusinessServicesArray();
      turnServiceSelect.innerHTML = "";

      if (services.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.disabled = true;
        opt.selected = true;
        opt.textContent = "Primero configura tus servicios";
        turnServiceSelect.appendChild(opt);
        return;
      }

      const placeholderOpt = document.createElement("option");
      placeholderOpt.value = "";
      placeholderOpt.disabled = true;
      placeholderOpt.selected = true;
      placeholderOpt.textContent = "Selecciona un servicio";
      turnServiceSelect.appendChild(placeholderOpt);

      services.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        turnServiceSelect.appendChild(opt);
      });
    }

    if (addTurnBtn && turnModal) {
      addTurnBtn.addEventListener("click", () => {
        // Limpiar campos
        turnTimeInput.value = "";
        turnClientInput.value = "";
        turnStatusSelect.value = "Confirmado";
        fillServicesInTurnSelect();

        turnModal.style.display = "flex";
      });

      cancelTurnBtn.addEventListener("click", () => {
        turnModal.style.display = "none";
      });

      saveTurnBtn.addEventListener("click", () => {
        const time = turnTimeInput.value;
        const client = turnClientInput.value.trim();
        const service = turnServiceSelect.value;
        const status = turnStatusSelect.value;

        if (!time || !client || !service) {
          alert("Por favor completa la hora, el cliente y el servicio.");
          return;
        }

        const turns = loadTurns();
        turns.push({
          id: Date.now(),
          time,
          client,
          service,
          status,
        });

        saveTurns(turns);
        renderTurns();
        turnModal.style.display = "none";
      });

      // cerrar si se hace click fuera del cuadro
      turnModal.addEventListener("click", (e) => {
        if (e.target === turnModal) {
          turnModal.style.display = "none";
        }
      });
    }

    // Al cargar, renderizar servicios, nombre negocio, precios de planes y turnos
    renderServices();
    updateBusinessNameLineForLang(currentLang);
    updatePlanPrices();
    renderTurns();
  </script>
</body>
</html>
